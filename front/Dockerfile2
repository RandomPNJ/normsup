FROM node:8 AS build

RUN mkdir -p /usr/src/app && \
  chown -R node:node /usr/src/app && \
  chown -R node:node /usr/local/lib/node_modules && \
  chown -R node:node /usr/local/bin/

RUN npm install -g npm@5.6.0

USER node
ADD package.json /tmp/package.json

RUN ls /tmp

RUN npm install -g @angular/cli@6.2.7
RUN cd /tmp && npm install -f && \
  mv /tmp/node_modules /usr/src/app/node_modules

ADD . /usr/src/app
WORKDIR /usr/src/app

#RUN chown -R node:node /usr/src/app
RUN cd /usr/src/app && ng build --prod


### STAGE 2: Run ###
FROM nginx:1.17.1-alpine
COPY --from=build /usr/src/app/dist/normsup-app /usr/share/nginx/html